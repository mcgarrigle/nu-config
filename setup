#!/usr/bin/env nu

def copy-to [ dir ] {
  let files = collect
  mkdir $dir
  $files | each { |file| 
    let dest = $dir | path join ($file.name | path basename) 
    print $"copy ($file.name) ($dest)"
    cp --force $file.name $dest
  }
  print ""
}

def append-to [ env_file ] {
  let files = collect
  $files | each { |file| 
    print $"append ($file.name) env.nu"
    open $file.name | save --append $env_file
  }
  print ""
}

# -------------------------------------------------

# copy config and scripts

let $autoload_dir = $nu.user-autoload-dirs.0
let scripts_dir   = $nu.default-config-dir | path join "scripts"
let env_file      = $nu.default-config-dir | path join "env.nu"

ls autoload | copy-to $autoload_dir
ls config   | copy-to $nu.default-config-dir
ls -a home  | copy-to $env.HOME

# append these files to {config}/env.nu

ls env | append-to $env_file

# install plugins

/usr/libexec/nushell/post-install.nu

# install carapace completions

mkdir $nu.cache-dir

$env.CARAPACE_BRIDGES = 'zsh,fish,bash,inshellisense' # optional
carapace _carapace nushell | save --force $"($nu.cache-dir)/carapace.nu"

null
